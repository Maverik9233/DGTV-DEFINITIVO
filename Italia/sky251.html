<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sky Sport 251</title>

  <!-- Librerie -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

  <style>
    :root{
      --accent:#00bfff;
      --bg:#000;
      --card:#0f0f0f;
      --text:#fff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px;text-align:center}
    .logo{width:210px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:block;margin:8px auto}
    h1{margin:10px 0 6px;color:var(--accent);text-shadow:0 0 10px rgba(0,191,255,0.12);font-size:26px}
    .player-outer{position:relative;width:100%;padding-top:56.25%;margin:18px auto}
    video, iframe { position:absolute; top:0; left:0; width:100%; height:100%; border:0; border-radius:10px; background:#000; box-shadow:0 6px 30px rgba(0,0,0,0.6) }
    iframe{display:none}
    video{display:block}
    .controls { margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap }
    button { background:var(--card); color:var(--text); border:1px solid #222; padding:8px 12px; border-radius:8px; cursor:pointer }
    .status { margin-top:12px; color:#ddd; font-size:0.95rem }
    .error { color:#ff8a8a }
  </style>
</head>
<body>
  <div class="wrap">
    <img class="logo" src="https://www.sportspro.com/wp-content/uploads/2023/04/Sky_Sports_Logo_September_2020-1.png" alt="Logo">
    <h1>Sky Sport 251</h1>

    <div class="player-outer">
      <video id="video" controls playsinline></video>
      <iframe id="iframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" allowfullscreen></iframe>
    </div>

    <div class="controls">
      <button id="btnRetry">Riprova (fallback)</button>
      <button id="btnOpen">Apri in nuova finestra</button>
      <button id="btnMute">Disattiva/Attiva audio</button>
    </div>

    <div class="status" id="status">Stato: pronto</div>
  </div>

<script>
/*
  Player universale:
  - Prova: DIRECT -> PROXY_PRIMARY -> PROXY_FALLBACK -> IFRAME
  - Supporta .m3u8 (HLS), .mpd (DASH), mp4/webm, php/html iframe, e file "camuffati" (.css)
  - Modifica `originalSource` con il link che vuoi riprodurre
  - Imposta proxyPrimary/secondary ai tuoi worker o ad altri proxy se ne hai
*/

const video = document.getElementById('video');
const iframe = document.getElementById('iframe');
const statusEl = document.getElementById('status');
const btnRetry = document.getElementById('btnRetry');
const btnOpen = document.getElementById('btnOpen');
const btnMute = document.getElementById('btnMute');

let isMuted = false;

// === CONFIG ===
const originalSource = "https://dlhd.dad/embed/stream-870.php"; // cambia qui
const proxyPrimary  = "https://proxypercss.mauriziot.workers.dev/?url=";
const proxyFallback = "https://streamproxy.mauriziot.workers.dev/?url="; // puoi aggiungerne un altro se vuoi

// === HELPERS ===
function setStatus(txt, isError=false){
  statusEl.innerHTML = (isError?'<span class="error">':'') + 'Stato: ' + txt + (isError?'</span>':'');
  console.log('PLAYER:',txt);
}
function proxify(url, proxy) {
  return proxy + encodeURIComponent(url);
}
function isHLS(url){ return /\.m3u8(\?.*)?$/.test(url); }
function isDASH(url){ return /\.mpd(\?.*)?$/.test(url); }
function isVideoFile(url){ return /\.(mp4|mkv|webm)(\?.*)?$/.test(url); }
function looksLikeIframe(url){ return url.endsWith('.php') || url.endsWith('.html') || url.endsWith('.htm') || url.includes('twitch.tv') || url.includes('kick.com') || url.includes('player.twitch.tv'); }

// === CORE: attempt chain ===
const attempts = [];
function buildAttempts(orig) {
  attempts.length = 0;
  // 1) try direct (if scheme allowed)
  attempts.push({type:'direct', url:orig});

  // 2) if .css or suspicious, try proxied HLS
  attempts.push({type:'proxy', url: proxify(orig, proxyPrimary)});

  // 3) fallback proxy (same here; replace if you have another proxy)
  attempts.push({type:'proxy', url: proxify(orig, proxyFallback)});

  // 4) iframe fallback (open page)
  attempts.push({type:'iframe', url: orig});
}

let currentAttempt = 0;
let hlsInstance = null;
let dashPlayer = null;

async function tryNext() {
  if (currentAttempt >= attempts.length) {
    setStatus('Tutti i tentativi falliti — prova un altro link o apri in un player esterno', true);
    showIframe(originalSource); // ultima chance
    return;
  }

  const attempt = attempts[currentAttempt++];
  setStatus(`Tentativo ${currentAttempt}/${attempts.length}: ${attempt.type} → ${attempt.url}`);

  // cleanup previous
  cleanupPlayers();

  try {
    if (attempt.type === 'direct' || attempt.type === 'proxy') {
      const url = attempt.url;

      // HLS path
      if (isHLS(url) || url.toLowerCase().endsWith('.css')) {
        // try HLS.js with the given url
        if (Hls.isSupported()) {
          hlsInstance = new Hls({ maxBufferLength: 30 });
          hlsInstance.on(Hls.Events.ERROR, (event, data) => {
            const isFatal = data && data.fatal;
            console.warn('HLS.js error', data);
            if (isFatal) {
              hlsInstance.destroy();
              hlsInstance = null;
              setTimeout(tryNext, 250); // try next option
            }
          });
          hlsInstance.loadSource(url);
          hlsInstance.attachMedia(video);
          // wait manifest parsed a short time
          hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
            video.style.display='block';
            iframe.style.display='none';
            video.muted = isMuted;
            video.volume = 1.0;
            video.play().catch(()=>{});
            setStatus('Riproduzione avviata (HLS)');
          });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.play().then(()=> setStatus('Riproduzione avviata (HLS nativo)')).catch(e=>{
            console.warn(e);
            setTimeout(tryNext, 200);
          });
        } else {
          // no HLS support -> go next
          setTimeout(tryNext, 200);
        }
        return;
      }

      // DASH path
      if (isDASH(url)) {
        try {
          dashPlayer = dashjs.MediaPlayer().create();
          dashPlayer.initialize(video, url, true);
          setStatus('Riproduzione avviata (DASH)');
          return;
        } catch(e){
          console.warn('DASH error', e);
          setTimeout(tryNext,200);
          return;
        }
      }

      // direct video file (mp4/mkv/webm)
      if (isVideoFile(url)) {
        video.src = url;
        video.play().then(()=> setStatus('Riproduzione avviata (file)')).catch(()=>{
          setTimeout(tryNext,200);
        });
        return;
      }

      // otherwise try to load as HLS (some php/css endpoints actually return HLS)
      // try HLS once more
      if (Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
          video.style.display='block';
          iframe.style.display='none';
          video.muted = isMuted;
          video.volume = 1.0;
          video.play().catch(()=>{});
          setStatus('Riproduzione avviata (HLS fallback)');
        });
        hlsInstance.on(Hls.Events.ERROR, () => {
          hlsInstance.destroy();
          hlsInstance = null;
          setTimeout(tryNext,200);
        });
        return;
      }

      // final fallback for this attempt: go next
      setTimeout(tryNext, 200);
      return;
    }

    if (attempt.type === 'iframe') {
      showIframe(attempt.url);
      setStatus('Aperto in iframe come ultima risorsa');
      return;
    }
  } catch (err) {
    console.error('Errore during attempt:', err);
    setTimeout(tryNext, 200);
  }
}

function cleanupPlayers(){
  // Hls
  try { if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; } } catch(e){}
  // dash
  try { if (dashPlayer) { dashPlayer.reset(); dashPlayer = null; } } catch(e){}
  // stop video
  try { video.pause(); video.removeAttribute('src'); video.load(); } catch(e){}
}

function showIframe(url) {
  iframe.src = url;
  iframe.style.display = 'block';
  video.style.display = 'none';
}

// === actions
btnRetry.addEventListener('click', () => {
  setStatus('Riprovo manualmente...');
  currentAttempt = 0;
  buildAttempts(originalSource);
  tryNext();
});
btnOpen.addEventListener('click', () => {
  window.open(originalSource, '_blank');
});
btnMute.addEventListener('click', () => {
  isMuted = !isMuted;
  video.muted = isMuted;
  btnMute.textContent = isMuted ? 'Audio: Off' : 'Audio: On';
});

// auto-start
buildAttempts(originalSource);
tryNext();

</script>
</body>
</html>
